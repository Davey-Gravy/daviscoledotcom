{{- /* Gallery with modal lightbox */ -}}
{{- $id := .Get "id" | default (printf "gal-%d" now.Unix) -}}
{{- $imagesParam := .Get "images" -}}

{{- $images := slice -}}
{{- if $imagesParam -}}
  {{- range (split $imagesParam ",") -}}
    {{- $p := trim . " " -}}
    {{- with $.Page.Resources.GetMatch $p -}}
      {{- $images = $images | append (dict "src" .RelPermalink "alt" (or .Params.alt .Name)) -}}
    {{- else -}}
      {{- $images = $images | append (dict "src" (relURL $p) "alt" (path.Base $p)) -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- range .Page.Resources.ByType "image" -}}
    {{- $images = $images | append (dict "src" .RelPermalink "alt" (or .Params.alt .Name)) -}}
  {{- end -}}
{{- end -}}

{{- if not (len $images) -}}
  <p class="text-secondary">No images found.</p>
{{- else -}}
  {{- $modalId := printf "%s-modal" $id -}}

  <div id="{{ $id }}" class="gallery-shortcode">
    {{- range $i, $img := $images -}}
      <button
        type="button"
        data-modal-target="{{ $modalId }}"
        data-src="{{ $img.src }}"
        aria-label="{{ $img.alt }}">
        <img
          src="{{ $img.src }}"
          alt="{{ $img.alt }}"
          loading="lazy" />
      </button>
    {{- end -}}
  </div>

  <!-- Modal -->
  <div id="{{ $modalId }}" class="gallery-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="gallery-modal-backdrop" data-close></div>
    <div class="gallery-modal-content">
      <button type="button" class="gallery-modal-close" aria-label="Close" data-close>&times;</button>
      <img id="{{ $id }}-full" src="{{ (index $images 0).src }}" alt="" />
    </div>
  </div>

  <script>
  (() => {
    const grid = document.getElementById('{{ $id }}');
    const modal = document.getElementById('{{ $modalId }}');
    const full = document.getElementById('{{ $id }}-full');
    if (!grid || !modal || !full) return;

    function openModal() {
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    // Thumbnail click
    grid.querySelectorAll('[data-src]').forEach(btn => {
      btn.addEventListener('click', () => {
        full.src = btn.dataset.src;
        full.alt = btn.getAttribute('aria-label') || '';
        openModal();
      });
    });

    // Close handlers
    modal.querySelectorAll('[data-close]').forEach(el => {
      el.addEventListener('click', closeModal);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        closeModal();
      }
    });
  })();
  </script>
{{- end -}}
